# Mise à jour
# Documentation non complete
Documentation de mise à jour pour Rocket.Chat sur l’infra de Unixcorn.

## Environnement
Le serveur Rocket.Chat est configuré de la manière suivante :
  * **/srv/rocketchat** : Path locale contenant les fichiers du serveur Rocket.Chat
  * **/etc/systemd/system/rocketchat.service** : Unit systemd pour le lancement de Rocket.Chat
  * **/srv/rocketchat/RCLaunch.sh** : Script de lancement
  * **127.0.0.1:27017/rocketchat** : URL de la base de donnée MongoDB.

## Téléchargement de l’archive
Rendez vous sur la [page de téléchargement](https://rocket.chat/download) de Rocket.Chat.  
En bas de page, vous trouverez les liens de téléchargement du serveur Rocket.Chat.  
Sélectionnez la dernière version (Stable si possible) et le copier.

Sur le serveur Rocket.Chat, passez un utilisateur rocketchat et allez dans le répertoire contenant les fichiers Rocket.Chat :
```bash
root # su - rocketchat --shell=/bin/bash
rocketchat $ cd /srv/rocketchat
```

Créez s’il n’existe pas un dossier temporaire **tmp** puis téléchargez l’archive à l’intérieur :
```bash
rocketchat $ mkdir tmp
rocketchat $ cd tmp
rocketchat $ wget <url de la version de rocketchat> -O rocketchat-server.tgz
```
## Arrêt du serveur
En premier lieu, il faut arrêter le serveur rocketchat :
```bash
root # systemctl stop rocketchat.service
```

## Backup de la BDD
MongoDB à une collection d’outils intégré permettant de gérer les import/export de base de données.  
Pour lancer le backup de la base de données, nous utiliserons **mongodump** :
```bash
root # su - mongodb --shell=/bin/bash
mongodb $ mkdir /tmp/mongodbbackup
mongodb $ mongodump -d rocketchat --out /tmp/mongodbbackup/rocketchat.mongo
```
Ceci fait, la base de données mongodb est sauvegardé.

## Backup du serveur
Le backup du serveur Rocket.Chat est une simple copie des fichiers.

```bash
root # su - rocketchat --shell=/bin/bash
rocketchat $ cd /srv/rocketchat
rocketchat $ rsync -avuz Rocket.Chat Rocket.Chat--old
```

Pas plus, pas moins

## Upgrade du serveur
Une fois votre [Backup de BDD fait](#Backup de la BDD) et votre [Backup du serveur](#Backup du serveur) fait, vous pouvez passer à l’ugrade en lui même.  
Pour ce faire, il faut en premier lieu extraire l’archive précédemment téléchargé :
```bash
root # su - rocketchat --shell=/bin/bash
rocketchat $ cd /srv/rocketchat/tmp
rocketchat $ tar xf rocketchat-server.tgz
rocketchat $ rsync -av bundle/ /srv/rocketchat/Rocket.Chat/
```

Une fois la copie finie, il suffit de redémarrer le serveur et d’attendre que l’upgrade de la base soit fini :
```bash
root # systemctl start rocketchat.service
```
Pour suivre le démarrage du serveur il faut utiliser **journalctl** :
```bash
root # journalctl -u rocketchat.service -f
```

## Bibliographie
  * [Rocket.Chat Unixcorn](https://chat.unixcorn.org)
  * [Site officiel de Rocket.Chat](https://rocket.chat)
  * [Page de téléchargement de Rocket.Chat](https://rocket.chat/download)

## Liste des commandes
```bash
su - rocketchat --shell=/bin/bash
cd /srv/rocketchat
mkdir tmp
cd tmp
wget <url> -O rocketchat-server.tgz
exit
systemctl stop rocketchat.service
su - mongodb --shell=/bin/bash
mkdir /tmp/mongodbbackup
mongodump -d rocketchat --out /tmp/mongodbbackup/rocketchat.mongo
exit
su - rocketchat --shell=/bin/bash
rsync -avuz Rocket.Chat Rocket.Chat--old
cd /srv/rocketchat/tmp
tar xf rocketchat-server.tgz
rsync -av bundle/ /srv/rocketchat/Rocket.Chat/
exit
systemctl start rocketchat.service
journalctl -u rocketchat.service -f
```
